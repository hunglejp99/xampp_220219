<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>emochart</title>
<link rel="stylesheet" href="css/grid.css">
<link rel="stylesheet" href="css/base.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
<style>
#conA_inner {
    display: flex;
    flex-direction: row-reverse;
    align-items: center;
}
#conA_inner span {
    color: #fff;
    margin-right: 0.5rem;
}
#conA_inner button {
    display: block;
    height: 1.4rem;
    line-height: 0.8rem;
    font-size: 0.8rem;
    padding-left: 0.3rem;
    padding-right: 0.3rem;
}
.container {
    max-width: 1000px;
    height: 100%;
    margin-right: auto;
    margin-left: auto;
    background-color: rgba(255, 255, 255, 0.6);
}
.form {
    width: 30vw;
}
#chart {
    width: 350px;
    height: 200px;
    top: 0;
    float: right;
}
#mychart {
    width: 350px;
    height: 200px;
}
#video {
    /* カメラ映像を流す video について */
    transform: scaleX(1);/* 左右反転させる(しない) */
    float: right;
}
.btn-solid {
    border-top: 4px solid #48ecc4;
    border-right: 4px solid #0a5f4a;
    border-bottom: 4px solid #0f745b;
    border-left: 4px solid #8cf9de;
    border-radius: 0;
    background: #11a37f;
}
.btn-solid span {
    color: #fff;
}
.btn-solid:hover {
    border-top: 4px solid #0f745b;
    border-right: 4px solid #8cf9de;
    border-bottom: 4px solid #48ecc4;
    border-left: 4px solid #0a5f4a;
}
ul {
    list-style: none;
}
.row {
    margin-left: 30px;
}
.row_rev {
    width: 30vw;
    overflow-y: scroll;
    height: 30vh;
}
.row_rev li {
    width: 50vw;
}
#log {
    color: #999999;
}
/* video 要素の上に canvas 要素をオーバーレイするための CSS */
#container {
    /* コンテナ用の div について */
    position: relative;/* 座標指定を相対値指定にする */
}
</style>
</head>

<body>
<div class="white_wrap">
  <div></div>
</div>
<header>
  <div class="conA">
    <div class="wrap-content" id="conA_inner">
      <button type="button" id="logout_btn" onclick="logoutOnclick();">LOGOUT</button>
    </div>
    <!--werap-content--> 
  </div>
  <div class="conB">
    <div class="wrap-content"> <img id="logo" src="img/logo-trim.png" alt="">
      <h1>読売<span id="kana">クイズ</span>学科</h1>
    </div>
    <!--werap-content--> 
  </div>
  <!--conB--> 
</header>
<div class="container">
  <div class="message_chart">
    <div id="chart">
      <canvas id="mychart"></canvas>
    </div>
    <!-- データ表示用 div 要素 -->
    
    <div class="message_box">
      <div class="comment">
        <ul id="message">
        </ul>
      </div>
      <ul id="pool" class="row_rev">
      </ul>
      <!-- カメラ映像を流す video -->
      <video id="video" width="350" height="300" autoplay></video>
      <ul id="log" class="row_rev">
      </ul>
      <form class="form" name="myform">
        <input name="text" type="text">
        <button class="btn-solid" name="btn"><span>送信</span></button>
        <button class="btn-solid" id="Logmode"><span>Log</span></button>
      </form>
    </div>
  </div>
  
  <!-- clmtrackr 関連ファイルの読み込み --> 
  <script src="js/clmtrackr.js"></script> <!-- clmtrackr のメインライブラリの読み込み --> 
  <script src="js/model_pca_20_svm_emotion.js"></script> <!-- 顔モデル（※1）の読み込み --> 
  <script src="js/emotionClassifier.js"></script> <!-- 感情を分類する外部関数の読み込み --> 
  <script src="js/emotionModel.js"></script> <!-- 感情モデル（※2）の読み込み --> 
  
  <!--<script type="text/javascript" src="script.js"></script> 画像を重ねる処理 --> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> <!-- jQuery本体 --> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/chart.min.js"></script> 
  <!--チャート表示ライブラリの読み込み-->
  
  <div id="output"></div>
</div>
<script>
		var socket = io.connect();                              //ソケット定義
		var pool = document.getElementById('pool');             //チャット固定コメント ul
	     var Log = document.getElementById('log');               //チャットLog 
		var form = document.forms.myform;                       //チャット入力フォーム form
	
	     socket.emit('LOG', "call");                             //過去ログ取得

		
	
		// ### cookieを配列として取り出し
        function getCookieArray() {
        var arr = new Array();
        if (document.cookie != "") {
            var tmp = document.cookie.split("; ");
            for (var i = 0; i < tmp.length; i++) {
            var data = tmp[i].split("=");
            arr[data[0]] = decodeURIComponent(data[1]);
            }
        }
        return arr;
        }
        arr = getCookieArray();
        socket.emit('check_cookie', arr['begginer']);
        window.addEventListener("popstate", function (e) {
            arr = getCookieArray();
            socket.emit('check_cookie', arr['begginer']);
        });
		
		                           
	
		//loginしているか
		socket.on('Login', function (ans) {
      if (!ans) {
        location.href = '/';
        alert("ログインに失敗しました！_checkemo")
      }
			   var Uname = document.createElement('span');
            Uname.textContent = " ようこそ、"+ans+"さん";
            document.getElementById('conA_inner').appendChild(Uname);
    });
		                       
	// コメント受け取る処理
		socket.on('chat', function (msg) {
		  var li = document.createElement('li');
		  li.textContent = msg;
		  pool.appendChild(li);
		  //createText(msg);
		});
	
	 //log受け取る処理
    socket.on('LOG', function (log) {
      var li = document.createElement('li');
      li.textContent = log;
      Log.appendChild(li);
    });

	
	
	
	 function logoutOnclick() {
            console.log("Logout")
            socket.emit('logout_cookie', arr['begginer']);
            alert("ログアウトしました")
            location.href = '/';
        } 
	function chatClick() {
            var hostname = window.location.hostname;
            location.href = `http://${hostname}/portal`;
        }
	
		// コメント送信
		form.btn.addEventListener('click', function (e) {
		  e.preventDefault();
		  if (!form.text.value == "") {
			socket.emit('chat', form.text.value);
			form.text.value = '';
			console.log("送信");
		  } else {
			console.log("送信してません");
		  }
		})
	
		
	
		
	  </script> 
<script>

    let tanoshi = []
    let odoroki = []
    let komatta = []

    // JavaScript Document
  
    var chartVal = [1, 1, 1]; // グラフデータ（描画するデータ）
    var chartCnt = 0;

    // getUserMedia によるカメラ映像の取得
    var media = navigator.mediaDevices.getUserMedia({ // メディアデバイスを取得
      video: {
        facingMode: "user"
      }, // カメラの映像を使う（スマホならインカメラ）
      audio: false // マイクの音声は使わない
    });
    media.then((stream) => { // メディアデバイスが取得できたら
      video.srcObject = stream; // video 要素にストリームを渡す
    });

    // clmtrackr の開始
    var tracker = new clm.tracker(); // tracker オブジェクトを作成
    tracker.init(pModel); // tracker を所定のフェイスモデル（※1）で初期化
    tracker.start(video); // video 要素内でフェイストラッキング開始

    // 感情分類の開始
    var classifier = new emotionClassifier(); // emotionClassifier オブジェクトを作成
    classifier.init(emotionModel); // classifier を所定の感情モデル（※2）で初期化

    //chart作成
    var ctx = document.getElementById('mychart');
    var myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ["happy", "spl", "troubled"],
        datasets: [{
          label: 'face',
          data: chartVal,
          backgroundColor: ['#f48', '#484', '#000CDF']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: '表情メーター'

          }
        }
      }
    });

    // 描画ループ
    function drawLoop() {
      requestAnimationFrame(drawLoop); // drawLoop 関数を繰り返し実行
      var positions = tracker.getCurrentPosition(); // 顔部品の現在位置の取得
      var parameters = tracker.getCurrentParameters(); // 現在の顔のパラメータを取得
      var emotion = classifier.meanPredict(parameters); // そのパラメータから感情を推定して emotion に結果を入れる
      
      //tracker.draw(canvas); // canvas にトラッキング結果を描画

      //フレームレート
      chartCnt++;
      if (chartCnt % 10 == 0) {
        SetChart(emotion[5].value, emotion[4].value, emotion[3].value);
      }
      //グラフの最大値固定
      myChart.options.scales.y.max = 0.5;
    }
    drawLoop(); // drawLoop 関数をトリガー


    // チャートを更新する
    //Array
    var tanoshi_emo = 0;
    var odoroki_emo = 0;
    var komatta_emo = 0;
    var tmpcount = 0;

    // チャートを更新する
    function SetChart(hp, spl, tro) {
      myChart.data.datasets.forEach(dataset => {
        dataset.data = [hp, spl, tro];
      });
      //それぞれのカウントを足している
      //hpが0.3より多いか等しい

      if (hp >= 0.5) {

        tanoshi_emo += 1;

      }
      //splが0.3より多いか等しい
      if (spl >= 0.3) {

        odoroki_emo += 1;

      }
      //troが0.3より多いか等しい
      if (tro >= 0.3) {

        komatta_emo += 1;

      }
      myChart.update();
      //自動化
      //OnButtonClick();
    }
    //interval
    const intervalId = setInterval(OnButtonClick, 1000);

    var last_tanoshicount = 0;
    var last_odorokicount = 0;
    var last_komattacount = 0;

    var arr_hp = new Array(30);
    var arr_spl = new Array(30);
    var arr_tro = new Array(30);

    //感情請求
    socket.on('chart', function (val) {
      console.log("感情要求: " + val)
      Emo_count();
    });
    function OnButtonClick() {
      for (i = 30; i > 1; i--) {
        arr_hp[i - 1] = arr_hp[i - 2];
        arr_spl[i - 1] = arr_spl[i - 2];
        arr_tro[i - 1] = arr_tro[i - 2];
      }
      arr_hp[0] = tanoshi_emo;
      arr_spl[0] = odoroki_emo;
      arr_tro[0] = komatta_emo;
      last_tanoshicount = arr_hp[29];
      last_odorokicount = arr_spl[29];
      last_komattacount = arr_tro[29];
    }
    function Emo_count() {
      
      target = document.getElementById("output");
      //配列の長さ	  
      let tanoshicount = tanoshi_emo;
      let odorokicount = odoroki_emo;
      let komattacount = komatta_emo;

      var tmptanoshi = tanoshicount - last_tanoshicount;
      var tmpodoroki = odorokicount - last_odorokicount;
      var tmpkomatta = komattacount - last_komattacount;

      var kanzyou = 0;

      console.log("楽しい:" + tmptanoshi + " 驚き:" + tmpodoroki + " 困惑:" + tmpkomatta);
      if (tmpkomatta == tmptanoshi && tmpkomatta == tmpodoroki) {
        kanzyou = 0;
        console.log("変化なし");
      } else {
        if (tmpkomatta >= tmptanoshi && tmpkomatta >= tmpodoroki) {
          kanzyou = 1;
          console.log("困った");
      
        } else if (tmpodoroki >= tmptanoshi && tmpodoroki >= tmpkomatta) {
          kanzyou = 2;
          console.log("驚き");
     
        } else if (tmptanoshi >= tmpodoroki && tmptanoshi >= tmpkomatta) {
          kanzyou = 3;
          console.log("楽しい");
         
        }
      }
      //カウント表示
      target.innerHTML = "楽しい:" + tanoshicount + " 驚き:" + odorokicount + " 困惑:" + komattacount;

      socket.emit('chart', kanzyou);
      console.log(kanzyou + "send!");
    }     
  </script>
</body>
</html>